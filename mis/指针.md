# ç†è§£æŒ‡é’ˆéœ€è¦çš„èƒŒæ™¯çŸ¥è¯†
1. å¯¹ç”µè„‘å†…å­˜æœ‰è®¤è¯†ã€‚
2. é€šè¿‡ä½¿ç”¨æŒ‡é’ˆå­¦ä¹ æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ï¼Œ`å•é“¾è¡¨ï¼ŒåŒé“¾è¡¨ï¼Œå¾ªç¯é“¾è¡¨ï¼ŒäºŒå‰æ ‘ç­‰`
3. ç†è§£`ownership, lifetime, levels of indirection, memory-safe`
## ğŸ¯ç›®æ ‡
> 1. æŒ‡é’ˆå¹¶ä¸å¥‡æ€ª
>    1. ä¸ä¼šå¥‡æ€ª`*`çš„ä½œç”¨
> 2. å¦‚ä½•ä½¿ç”¨æŒ‡é’ˆï¼Œå¹¶å…‹æœå…¶ç¼ºç‚¹
>    1. é€šè¿‡è®¸å¤šå°ä¾‹é¢˜ï¼Œç†è§£æŒ‡é’ˆçš„ç®€å•å†…å®¹åˆ°é«˜çº§å†…å®¹(åŒ…æ‹¬å‡½æ•°æŒ‡é’ˆï¼‰
> 3. ç†è§£`C++`çš„æŒ‡é’ˆ
>    1. ä½¿ç”¨ç°ä»£`C++`ç‰¹æ€§ï¼Œæ™ºèƒ½æŒ‡é’ˆå’Œ`std::function`


# â“æŒ‡é’ˆæ˜¯ä»€ä¹ˆ

- ä¸€ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå­˜å‚¨ç‰¹å®šå¯¹è±¡ç±»å‹çš„å†…å­˜åœ°å€ã€‚
   - `px`æ˜¯ä¸€ä¸ªæŒ‡é’ˆ
   - `px`çš„ç±»å‹æ˜¯`int*`
      - `px`å­˜å‚¨æ•´å½¢çš„å†…å­˜åœ°å€
   - æˆ‘ä»¬é€šè¿‡`&`ç¬¦åˆè·å¾—å˜é‡`x`çš„å†…å­˜åœ°å€
   - èµ‹å€¼ç¬¦å·`=`å°†å†…å­˜åœ°å€ç»™äºˆ`px`
      - æˆ‘ä»¬å¯ä»¥è¯´`pxæŒ‡å‘x`
- å¦‚æœ`px`å­˜å‚¨äº†`x`çš„å†…å­˜åœ°å€ï¼Œåˆ™
   - å¯ä»¥é€šè¿‡`px`é—´æ¥è®¿é—®`x`çš„å€¼
   - `x`å­˜å‚¨çš„å€¼ä¸º`7`
   - ç¬¬11è¡Œï¼ŒæŒ‡é’ˆå˜é‡`px`å‰é¢æœ‰ä¸€ä¸ªç¬¦å·`*`
      - è¿™ä¸ªæ—¶å€™ï¼Œ`*`å·è¡¨ç¤ºè§£å¼•ç”¨ï¼Œä»`px`æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€æå–å€¼ã€‚
      - æ‰€ä»¥`*px`æå–çš„å€¼å°±æ˜¯`7`ï¼Œå› ä¸º`px`å­˜å‚¨çš„å†…å­˜åœ°å€æŒ‡å‘äº†`x`
```cpp
#include <iostream>
#include <iomanip>

int main () {
    int x = 7;
    int* px = &x;
    int** ppx = &px;

    std::cout << "x is: " << x << std::endl;
    std::cout << "px is: " << px << std::endl;
    std::cout << "px is: " << *px << std::endl;
    std::cout << "ppx is: " << ppx << std::endl;
    std::cout << "ppx is: " << *ppx << std::endl;
    std::cout << "ppx is: " << sizeof(ppx) << std::endl;

    // int y = 1 << 31;
    // int z = 1 << 3;
    // int a = y >> 31;
    // // y = 0b1000 0000 0000 0000 0000 0000 0000 0000 
    // // std::ostream oy(y, std::ios::out | std::ios::binary);
    // std::cout << std::bitset<32>(y) << std::endl;
    // std::cout << y << std::endl;
    // std::cout <<(unsigned) y << std::endl;
    // std::cout << std::bitset<32>(z) << std::endl;
    // std::cout << z << std::endl;
    // std::cout << std::bitset<32>(a) << std::endl;
    // std::cout << a << std::endl;
    // std::cout << (unsigned) a << std::endl;
    // std::cout << (int)0xFFFFFFFF<< std::endl;

}
```
# é€šè¿‡å›¾ç‰‡ç†è§£æŒ‡é’ˆå’Œå†…å­˜
![2560px-Linux_Virtual_Memory_Layout_64bit.svg.png](https://cdn.nlark.com/yuque/0/2023/png/2582805/1693543951731-75b51dfd-f4a0-4779-b5d7-6a434bae2e33.png#averageHue=%23010101&clientId=u75b79631-989a-4&from=ui&id=ua95fe3fa&originHeight=1810&originWidth=2560&originalType=binary&ratio=2&rotation=0&showTitle=false&size=220827&status=done&style=none&taskId=u4adc6c32-8616-4735-a5b6-37f93fb7f9b&title=)
> 1. [linux-memory-allcator](http://joyxu.github.io/2020/08/21/linux-memory-allcator/)
> 2. [https://elinux.org/images/b/b0/Introduction_to_Memory_Management_in_Linux.pdf](https://elinux.org/images/b/b0/Introduction_to_Memory_Management_in_Linux.pdf)
> 3. [https://gist.github.com/CMCDragonkai/10ab53654b2aa6ce55c11cfc5b2432a4](https://gist.github.com/CMCDragonkai/10ab53654b2aa6ce55c11cfc5b2432a4)
> 4. [https://simonis.github.io/Memory/](https://simonis.github.io/Memory/)

![image.png](https://cdn.nlark.com/yuque/0/2023/png/2582805/1693544604095-b6a867b3-9ff4-4203-b2c0-96c528672437.png#averageHue=%23f9edde&clientId=u75b79631-989a-4&from=paste&height=576&id=u3ffb556c&originHeight=1152&originWidth=1080&originalType=binary&ratio=2&rotation=0&showTitle=false&size=76214&status=done&style=none&taskId=u664d04a9-d222-499c-b85a-10803e09bfb&title=&width=540)
> 1. å¯ä»¥å°†`00_initialize.cpp`æ³¨é‡Šæ‰çš„åœ°æ–¹ï¼Œå°è¯•çœ‹çœ‹ï¼Œå¯¹ä½å¢å¼ºç†è§£ã€‚
> 2. ç†è§£å†…å­˜å¤§æ¦‚æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚å†…å­˜ç®¡ç†ï¼Œå†…å­˜æ˜ å°„ç­‰å†…å®¹è¶…è¿‡æœ¬è¯¾ç¨‹æ•™å­¦èŒƒå›´ï¼Œå¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥å‚è€ƒCSAPPè¯¾ç¨‹å’Œæ“ä½œç³»ç»Ÿè¯¾ç¨‹ã€‚


# æŒ‡é’ˆå’Œå…±äº«æ•°æ®
```cpp
#include <iostream>
#include <string>

struct Person {
    std::string nickname;
    /* ... assume more attributes */
};

struct School {
    Person* teacher;
};

struct Friends {
    Person* friend1;
};

int main() {
    Person wangyang;
    wangyang.nickname = "wangyang";

    Person* myFakeTwinBrother;
    Company myTeacher;
    Friends myFriends;

    // For each of these other objects,
    // share some data
    myFakeTwinBrother = &wangyang;
    mySchool.teacher = &wangyang;
    myFriends.friend1 = &wangyang;

    michael.nickname = "Mike";
    std::cout << "MyFakeTwinBrother also is :" << (*myFakeTwinBrother).nickname << std::endl;
    std::cout << "MyFakeTwinBrother stll is :" << myFakeTwinBrother->nickname << std::endl;
    std::cout << "My teacher is : " << mySchool.teacher->nickname << std::endl;
    std::cout << "My friend is : " << myFriends.friend1->nickname << std::endl;

    return 0;
}
```
```cpp
#include <iostream>
#include <cstdlib>

struct UserDefinedType {
    int x, y, z;
    char a, b, c;
    // +1 more bytes for padding
    int* d;
};

int main () {
    std::cout << "sizeof(bool)                  :" << sizeof(bool) << std::endl;
    std::cout << "sizeof(unsigned char)         :" << sizeof(unsigned char) << std::endl;
    std::cout << "sizeof(char)                  :" << sizeof(char) << std::endl;
    std::cout << "sizeof(short)                 :" << sizeof(short) << std::endl;
    std::cout << "sizeof(uint8_t)               :" << sizeof(uint8_t) << std::endl;
    std::cout << "sizeof(int)                   :" << sizeof(int) << std::endl;
    std::cout << "sizeof(float)                 :" << sizeof(float) << std::endl;
    std::cout << "sizeof(double)                :" << sizeof(double) << std::endl;
    std::cout << "sizeof(UserDefinedType)       :" << sizeof(UserDefinedType) << std::endl;
    // int x = 33;
    // UserDefinedType wangyang{2, 22, 222, 65, 97, 100, &x};

    // std::cout << wangyang.x << std::endl;
    // std::cout << wangyang.y << std::endl;
    // std::cout << wangyang.z << std::endl;
    // std::cout << &wangyang << std::endl;
    // std::cout << wangyang.b << std::endl;
    // std::cout << wangyang.c << std::endl;
    // std::cout << &wangyang.x << std::endl;
    // std::cout << &wangyang.y << std::endl;
    // std::cout << &wangyang.z << std::endl;
    return 0;
}
```
# å‡½æ•°ä½¿ç”¨æŒ‡é’ˆ
> 1. ä¼ å€¼ï¼Œ`passByValue`
> 2. ä¼ æŒ‡é’ˆï¼Œ`passByPointer`
> 3. äºŒè€…å…¶å®éƒ½æ˜¯ä¼ å€¼ï¼Œè¦ç†è§£æ­¤å¤„ã€‚

```cpp
#include <iostream>

void passByValue(int x) {
    x = 1;
    // std::cout << &x << std::endl;
}

void passByPointer(int* x) {
    *x = 1;
    std::cout << x << std::endl;
}

int main () {
    int x = 0;
    std::cout << &x << std::endl;
    passByValue(x);
    passByPointer(&x);
    return 0;
}
```

- å¯ä»¥æ‰“å¼€æ³¨é‡Šï¼Œçœ‹çœ‹æ˜¯å¦èƒ½ç†è§£ï¼Œä¼ æŒ‡é’ˆä¹Ÿæ˜¯åœ¨ä¼ å€¼ï¼Œåªæ˜¯ä¼ çš„å€¼æ˜¯åœ°å€ã€‚
# æŒ‡é’ˆå’Œæ•°ç»„
> 1. ç†è§£æŒ‡é’ˆå’Œæ•°ç»„çš„å¾®å°åŒºåˆ«ã€‚`sizeof(array)`å’Œ`sizeof(&array)`

```cpp
#include <iostream>
#include <array>
#include <iterator>
#include <typeinfo>

int main() {
    short array[3];
    std::cout << "sizeof(array) is: " << sizeof(array) << std::endl;
    std::cout << "sizeof(&array) is: " << sizeof(&array) << std::endl;
    std::cout << "sizeof(&array)" << sizeof(&array) << std::endl;
    // std::array<short, 3> array{1,2,3};
    // std::array<short, 3>* parr = &array;

    // for (size_t i = 0; i < array.size(); ++i) {
    //     std::cout << (*parr)[i] << std::endl;
    // }

    // short arr[3]{3, 3, 3};
 //    short arr[3];
	// for (int i = 0; i < 3; ++i ) {
 //        a[i] = i;
 //    }
    
 //    for (int i = 0; i < 3; ++i) {
 //        std::cout << arr[i] << std::endl;
 //        std::cout << *(arr + i) << std::endl;
 //        std::cout << *arr + i << std::endl;
 //    }

    // for (std::array<short, 3>::iterator it = array.begin(); it != array.end(); ++it) {
    //     std::cout << *it << std::endl;
    // }
	return 0;
}
```
> 1. è¿™ä¸ªå·®åˆ«æ˜¯å¦ä¸è‡ªå·±æ‰€æƒ³ä¸€è‡´ã€‚
> 2. æ•°ç»„é€€åŒ–ä¸ºæŒ‡é’ˆã€‚

```cpp
#include <iostream>

int main () {
    int array[120];
    int* count = array;
    for (size_t i = 0; i < (sizeof(array) / sizeof(int)); ++i) {
        array[i] = i;
    }
    for (size_t i = 0; i < 120; ++i) {
        std::cout << array[i] << "\n";
    }
    for (size_t i = 0; i < (sizeof(count)); ++i) {
        array[i]++;
    }
    for (size_t i = 0; i < 120; ++i) {
        std::cout << array[i] << "\n";
    }
    return 0;
}
```
```cpp
#include <iostream>
#include <array>

int main () {
    short array[6];
    for(int i = 0; i < 6; ++i) {
        array[i] = i;
    }

    // Pointer to start of array
    // Note: array versus &array[0]
    //       is slightly different.
    std::cout << "sizeof(array)     : " << sizeof(array) << std::endl;
    std::cout << "sizeof(&array[0]) : " << sizeof(&array[0]) << std::endl;
    std::cout << "sizeof(&array)    : " << sizeof(&array) << std::endl;
    std::cout << "array             : " << array << std::endl;
    std::cout << "&array[0]         : " << &array[0] << std::endl;
    std::cout << "&array            : " << &array << std::endl;
    return 0;
}
```
# æŒ‡é’ˆä½œä¸ºå‚æ•°
> 1. æ•°ç»„ä¼šé€€åŒ–ä¸ºæŒ‡é’ˆã€‚
> 2. æ•°ç»„å¯ä»¥åŒ…å«å¤§å°ï¼ŒæŒ‡é’ˆä¸è¡Œã€‚

```cpp
#include <iostream>
#include <array>

void arrayDecay(short* arr) {
    std::cout << "sizeof(arr)           : " << sizeof(arr) << std::endl;
}

int main() {
    short array[11]{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11};

    arrayDecay(array);

    return 0;
}
```
```cpp
#include <iostream>
#include <array>

template<int T>
void printAndWithoutSizeParameter(const std::array<short, T> &arr) {
    std::cout << "sizeof(arr)           : " << sizeof(arr) << std::endl;
}

int main() {
    std::array<short, 11> array{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11};

    printAndWithoutSizeParameter<array.size()>(array);

    std::array<short, 10> array2;
    printAndWithoutSizeParameter<10>(array2);

    return 0;
}
```
```bash
clang++ -std=c++20 -Xclang -ast-print -fsyntax-only 07_array_template.cpp > 07
```

- æ¨¡æ¿æ¨å¯¼çš„å°ç©æ„ï¼Œéç±»å‹å‡½æ•°æ¨¡æ¿
```cpp
template <int T> void printAndWithoutSizeParameter(const std::array<short, T> &arr) {
    std::cout << "sizeof(arr)           : " << sizeof (arr) << std::endl;
}
template<> void printAndWithoutSizeParameter<11>(const std::array<short, 11> &arr) {
    std::cout << "sizeof(arr)           : " << sizeof (arr) << std::endl;
}
template<> void printAndWithoutSizeParameter<10>(const std::array<short, 10> &arr) {
    std::cout << "sizeof(arr)           : " << sizeof (arr) << std::endl;
}
```

# åŠ¨æ€å†…å­˜åˆ†é…
```cpp
#include <iostream>

int main () {
    int* array = new int[4];
    for (int i = 0; i < 4; ++i) {
        array[i] = i;
    }
    int *array2 = array;
    std::cout << array[1] << std::endl;
    delete[] array;

    std::cout << array2[1] << std::endl;
    // delete[] array2;
    return 0;
}
```
> 1. `delete[]`æ–¹æ³•é‡Šæ”¾å†…å­˜ã€‚

# `nullptr`
```cpp
#include <iostream>

int main () {
    int* px = nullptr;

    std::cout << "What happens here? " << *px << std::endl;
    return 0;
}
```

- è¿™é‡Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
```cpp
#include <iostream>

int main () {
    int* px = nullptr;

    if (nullptr != px) {
        std::cout << "What happens here? " << *px << std::endl;
    }
    return 0;
}
```
> 1. å› ä¸ºæŒ‡é’ˆä¼šå…±äº«èµ„æºï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ€è€ƒ`ownership`ï¼Œæ‰€æœ‰æƒè¿™ä¸ªæ¦‚å¿µã€‚åˆ°åº•è°è´Ÿè´£åˆ é™¤åŠ¨æ€åˆ†é…çš„å†…å­˜ã€‚
> 2. å‚è€ƒ[Back to basics: RAII and the Rule of Zero](https://www.youtube.com/watch?v=7Qgd9B1KuMQ&t=601s)

# å†…å­˜æ³„æ¼
```cpp
#include <iostream>

int main () {
    int* array = new int[1000];
    while(1) {
        int* arr = new int[1];
    }
    return 0;
}
```
```bash
clang++ -std=c++20 -g -fsanitize=address 10_memory_leak.cpp -o prog
ASAN_OPTIONS=detect_leaks=1 ./prog
```

- è¿™ä¸ªæˆ‘åœ¨`mac`å¹³å°ä½¿ç”¨é—®é¢˜å¾ˆå¤§ï¼Œä½†æ˜¯åœ¨`Ubuntu 20.04 LTS`ä¸‹æ²¡æœ‰é—®é¢˜
# æ‚¬å‚æŒ‡é’ˆï¼Œdangling pointer
```cpp
#include <iostream>

char* dangerouslyReturnLocalValue() {
    char c = 'c';
    return &c;
}

int main() {
    char* danglingPointer = dangerouslyReturnLocalValue();

    std::cout << "*danglingPointer is : " << *danglingPointer << std::endl;
    return 0;
}
```

- æ‚¬å‚æŒ‡é’ˆå‡ºç°çš„åŸå› æ˜¯å½“ä½ æŒ‡å‘çš„åœ°å€ä¸å­˜åœ¨
   - ç°åœ¨å¤„ç†å™¨åº”è¯¥éƒ½ä¼šæç¤º
- è€ƒè™‘ç”Ÿå‘½å‘¨æœŸï¼Œå°½é‡ä¸è¦å°†ç”Ÿå‘½å‘¨æœŸä¸åŒçš„é‡å…³è”èµ·æ¥
> 1. å‚è€ƒ[memory management](https://isocpp.org/wiki/faq/freestore-mgmt)
> 2. [http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-return-ptr](http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-return-ptr)
> 3. [http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#f43-never-directly-or-indirectly-return-a-pointer-or-a-reference-to-a-local-object](http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#f43-never-directly-or-indirectly-return-a-pointer-or-a-reference-to-a-local-object)

# double frees
```bash
#include <iostream>

int main () {
    // float* f1 = new float[100];
    // float* f2 = f1;

    // delete[] f1;
    // f1 = nullptr;
    // delete[] f2;
    // f2 = nullptr;

    // delete[] f1;
    float* f1 = new float[100];
    float* f2 = f1;

    delete[] f2;
    f2 = nullptr;
    delete[] f1;
    f1 = nullptr;

    delete[] f2;
    return 0;
}
```
# æ¶ˆé™¤æŒ‡é’ˆçš„è´Ÿé¢

- å°½é‡ä¸è¦ä½¿ç”¨`raw/naked/plain`æŒ‡é’ˆï¼Œä½¿ç”¨`smart pointer`
- ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆ
- å¯ä»¥æ­é…`unique_ptr`å’Œå³å€¼æ¥è½¬ç§»æ‰€æœ‰æƒã€‚
```cpp
#include <iostream>

template <class T>
class MakeSafePointer {
public:
MakeSafePointer() {
    rawPointer = new T;
    use_count = 1;
}
~MakeSafePointer() {
    if (1 == use_count) {
        delete rawPointer;
        rawPointer = nullptr;
    } else {
        // Maybe long a warning if in DEBUG mode
    }
}
private:
T* rawPointer;
int use_count;
};

int main() {
    MakeSafePointer<int> int_ptr;

    return 0;
}
```
# æ™ºèƒ½æŒ‡é’ˆå’Œå‡½æ•°æŒ‡é’ˆ
è¿™ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œä¼šæ”¾åœ¨é¢å‘å¯¹è±¡éƒ¨åˆ†è®²è§£ã€‚
# â˜‘ï¸æ€»ç»“

1. åŸå§‹çš„æŒ‡é’ˆï¼Œä¸è¦ææƒ§ï¼Œæ…¢æ…¢ç†è§£ç”Ÿå‘½å‘¨æœŸã€æ‰€æœ‰æƒå’Œä½œç”¨èŒƒå›´ã€‚
2. ç†è§£åŸå§‹æŒ‡é’ˆçš„ä¼˜ç¼ºç‚¹ï¼Œè¿™æ ·å°±ä¼šè§‰å¾—æ™ºèƒ½æŒ‡é’ˆçš„å¥½å¤„ã€‚
3. ä»»ä½•äº‹æƒ…éƒ½æ˜¯æœ‰ä»£ä»·çš„ï¼Œæ™ºèƒ½æŒ‡é’ˆä¹Ÿä¸€æ ·ä¸å¯èƒ½æ²¡æœ‰åå¤„ã€‚

